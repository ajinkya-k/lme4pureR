library(lme4)
library(nloptwrap)
library(lme4pureR)
form <- cbind(incidence, size - incidence) ~ period + (1 | herd)
glmod <- glFormula(form, cbpp, binomial)
#gm1 <- glm(nobars(form), binomial, cbpp)
weights <- c(14, 12, 9, 5, 22, 18, 21, 22, 16, 16, 20, 10, 10, 9, 6, 18, 
             25, 24, 4, 17, 17, 18, 20, 16, 10, 9, 5, 34, 9, 6, 8, 6, 22, 
             22, 18, 22, 25, 27, 22, 22, 10, 8, 6, 5, 21, 24, 19, 23, 19, 
             2, 3, 2, 19, 15, 15, 15)
beta0 <- c(-1.26902348936715, -1.17076272514038, -1.30140533385642,
           -1.78227863534165)
ratios <- c(0.142857142857143, 0.25, 0.444444444444444, 0, 0.136363636363636, 
            0.0555555555555556, 0.0476190476190476, 0.363636363636364, 0.125, 
            0, 0.1, 0.2, 0, 0.222222222222222, 0, 0.277777777777778, 0, 0, 
            0.25, 0.176470588235294, 0, 0, 0.05, 0.5, 0.1, 0.333333333333333, 
            0, 0.352941176470588, 0.222222222222222, 0, 0, 0, 0.0454545454545455, 
            0.0454545454545455, 0, 0.0909090909090909, 0, 0.185185185185185, 
            0.136363636363636, 0.0454545454545455, 0.2, 0.125, 0, 0,
            0.0476190476190476, 0.0833333333333333, 0, 0, 0.578947368421053,
            0, 0, 0, 0.0526315789473684, 0.0666666666666667, 0.0666666666666667, 0)
eta <- c(-1.26902348936715, -2.43978621450753, -2.57042882322357, -3.0513021247088, 
         -1.26902348936715, -2.43978621450753, -2.57042882322357, -1.26902348936715,
         -2.43978621450753, -2.57042882322357, -3.0513021247088, -1.26902348936715, 
         -2.43978621450753, -2.57042882322357, -3.0513021247088, -1.26902348936715,
         -2.43978621450753, -2.57042882322357, -3.0513021247088, -1.26902348936715,
         -2.43978621450753, -2.57042882322357, -3.0513021247088, -1.26902348936715,
         -2.43978621450753, -2.57042882322357, -3.0513021247088, -1.26902348936715,
         -1.26902348936715, -2.43978621450753, -2.57042882322357, -3.0513021247088,
         -1.26902348936715, -2.43978621450753, -2.57042882322357, -3.0513021247088,
         -1.26902348936715, -2.43978621450753, -2.57042882322357, -3.0513021247088,
         -1.26902348936715, -2.43978621450753, -2.57042882322357, -3.0513021247088,
         -1.26902348936715, -2.43978621450753, -2.57042882322357, -3.0513021247088,
         -1.26902348936715, -2.43978621450753, -2.57042882322357, -3.0513021247088,
         -1.26902348936715, -2.43978621450753, -2.57042882322357, -3.0513021247088)

devf <- pirls(glmod, ratios, binomial(), weights=weights, eta=eta, nAGQ=1)
devf(c(1,beta0))
## dd <- glmer(form, cbpp, binomial, nAGQ=1L, devFunOnly=TRUE)
## dd(c(1,beta0)) # 187.597775722905
## mode of U|Y=y at theta = 1, beta = beta0
uvals0 <- c(0.673608188928336, -0.418296098551174, 0.430156616489803,
            0.0215570898840278, -0.259799407317694, -0.53597222937968,
            1.00421556687169, 0.586471703961822, -0.378215451100604,
            -0.71336623331095, -0.130148722292736, -0.128810741294145, 
            -0.917636142594895, 1.09648804850027, -0.732085506469876)
## environment(dd)$resp$allInfo()
##            y   offset weights        mu      rwt        wres      Xwt       eta     muEta       var    WrkWt     wrkRes    wrkResp      devRes
## 1  0.1428571 -1.26902      14 0.3553933  7.81739 -1.66147884 1.790878 -0.595415 0.2290889 0.2290889 1.790878 -0.9277453 -0.2541371 3.19362e+00
## 2  0.2500000 -2.43979      12 0.1460183  9.80986  1.02004600 1.223259 -1.766178 0.1246969 0.1246969 1.223259  0.8338756  1.5074837 8.89316e-01
## 3  0.4444444 -2.57043       9 0.1304687  8.90688  2.79654278 1.010455 -1.896821 0.1134466 0.1134466 1.010455  2.7676067  3.4412149 5.32567e+00
## 4  0.0000000 -3.05130       5 0.0848895  8.02271 -0.68104424 0.623231 -2.377694 0.0776833 0.0776833 0.623231 -1.0927643 -0.4191561 8.87105e-01
## 5  0.1363636 -1.26902      22 0.1561287 12.92206 -0.25540498 1.702514 -1.687320 0.1317525 0.1317525 1.702514 -0.1500163 -0.5683124 6.76352e-02
## 6  0.0555556 -2.43979      18 0.0542650 18.72800  0.02416892 0.961128 -2.858082 0.0513203 0.0513203 0.961128  0.0251464 -0.3931497 5.79823e-04
## 7  0.0476190 -2.57043      21 0.0479379 21.45051 -0.00683849 0.978997 -2.988725 0.0456398 0.0456398 0.978997 -0.0069852 -0.4252813 4.68637e-05
## 8  0.3636364 -1.26902      22 0.3017735 10.21816  0.63212467 2.153030 -0.838867 0.2107062 0.2107062 2.153030  0.2935977  0.7237543 3.85987e-01
## 9  0.1250000 -2.43979      16 0.1181956 12.39006  0.08430717 1.291358 -2.009630 0.1042254 0.1042254 1.291358  0.0652857  0.4954423 6.99294e-03
## 10 0.0000000 -2.57043      16 0.1052438 13.03495 -1.37184734 1.227469 -2.140272 0.0941675 0.0941675 1.227469 -1.1176228 -0.6874662 3.55853e+00
## 11 0.1000000 -3.05130      20 0.0677899 17.78999  0.57301791 1.124228 -2.621146 0.0631944 0.0631944 1.124228  0.5096991  0.9398558 2.89144e-01
## 12 0.2000000 -1.26902      10 0.2231390  7.59522 -0.17574608 1.316617 -1.247466 0.1733480 0.1733480 1.316617 -0.1334831 -0.1119260 3.16945e-02
## 13 0.0000000 -2.43979      10 0.0817932 11.53908 -0.94381792 0.866620 -2.418229 0.0751030 0.0751030 0.866620 -1.0890792 -1.0675221 1.70665e+00
## 14 0.2222222 -2.57043       9 0.0725023 11.56882  1.73208190 0.777953 -2.548872 0.0672457 0.0672457 0.777953  2.2264595  2.2480166 2.01555e+00
## 15 0.0000000 -3.05130       6 0.0461000 11.68083 -0.53848654 0.513662 -3.029745 0.0439748 0.0439748 0.513662 -1.0483280 -1.0267709 5.66358e-01
## 16 0.2777778 -1.26902      18 0.1781660 11.08745  1.10444122 1.623457 -1.528823 0.1464229 0.1464229 1.623457  0.6803023  0.4205028 1.08171e+00
## 17 0.0000000 -2.43979      25 0.0629978 20.57960 -1.29646989 1.214795 -2.699586 0.0590291 0.0590291 1.214795 -1.0672334 -1.3270328 3.25348e+00
## 18 0.0000000 -2.57043      24 0.0557124 21.35884 -1.18995180 1.123657 -2.830228 0.0526085 0.0526085 1.123657 -1.0589994 -1.3187988 2.75158e+00
## 19 0.2500000 -3.05130       4 0.0351923 10.85390  2.33150120 0.368531 -3.311102 0.0339538 0.0339538 0.368531  6.3264699  6.0666705 2.41013e+00
## 20 0.1764706 -1.26902      17 0.1412440 11.83871  0.41703719 1.435967 -1.804996 0.1212942 0.1212942 1.435967  0.2904226 -0.2455496 1.63196e-01
## 21 0.0000000 -2.43979      17 0.0485331 19.18706 -0.93120806 0.886014 -2.975758 0.0461777 0.0461777 0.886014 -1.0510087 -1.5869810 1.69151e+00
## 22 0.0000000 -2.57043      18 0.0428440 20.95077 -0.89761445 0.859157 -3.106401 0.0410084 0.0410084 0.859157 -1.0447618 -1.5807340 1.57640e+00
## 23 0.0500000 -3.05130      20 0.0269284 27.62720  0.63740250 0.723924 -3.587274 0.0262033 0.0262033 0.723924  0.8804825  0.3445103 3.25845e-01
## 24 0.5000000 -1.26902      16 0.4341822  8.07023  0.53116463 1.982596 -0.264808 0.2456680 0.2456680 1.982596  0.2679137  1.2721292 2.79677e-01
## 25 0.1000000 -2.43979      10 0.1922322  8.02497 -0.74016103 1.246110 -1.435571 0.1552790 0.1552790 1.246110 -0.5939773  0.4102382 6.39094e-01
## 26 0.3333333 -2.57043       9 0.1727569  7.93573  1.27429158 1.134111 -1.566213 0.1429119 0.1429119 1.134111  1.1236040  2.1278196 1.35384e+00
## 27 0.0000000 -3.05130       5 0.1143471  7.02653 -0.80346286 0.711589 -2.047087 0.1012718 0.1012718 0.711589 -1.1291105 -0.1248949 1.21430e+00
## 28 0.3529412 -1.26902      34 0.3356920 12.34765  0.21298664 2.753561 -0.682552 0.2230029 0.2230029 2.753561  0.0773495  0.6638212 4.49936e-02
## 29 0.2222222 -1.26902       9 0.1614825  8.15272  0.49519421 1.103926 -1.647239 0.1354059 0.1354059 1.103926  0.4485755  0.0703600 2.24400e-01
## 30 0.0000000 -2.43979       6 0.0563591 10.62161 -0.59862429 0.564886 -2.818002 0.0531828 0.0531828 0.564886 -1.0597252 -1.4379406 6.96115e-01
## 31 0.0000000 -2.57043       8 0.0498006 13.00230 -0.64752274 0.615276 -2.948644 0.0473205 0.0473205 0.615276 -1.0524107 -1.4306262 8.17335e-01
## 32 0.0000000 -3.05130       6 0.0313856 14.04866 -0.44092563 0.427087 -3.429518 0.0304005 0.0304005 0.427087 -1.0324026 -1.4106180 3.82664e-01
## 33 0.0454545 -1.26902      22 0.1210643 14.37887 -1.08718303 1.530023 -1.982390 0.1064078 0.1064078 1.530023 -0.7105664 -1.4239327 1.50677e+00
## 34 0.0454545 -2.43979      22 0.0409672 23.66335  0.10618463 0.929708 -3.153152 0.0392889 0.0392889 0.929708  0.1142129 -0.5991533 1.09014e-02
## 35 0.0000000 -2.57043      18 0.0361313 22.73450 -0.82142746 0.791748 -3.283795 0.0348258 0.0348258 0.791748 -1.0374857 -1.7508520 1.32481e+00
## 36 0.0909091 -3.05130      22 0.0226504 31.52454  2.15182472 0.697869 -3.764668 0.0221373 0.0221373 0.697869  3.0834219  2.3700556 2.66276e+00
## 37 0.0000000 -1.26902      25 0.1979475 12.54855 -2.48395440 1.992262 -1.399172 0.1587643 0.1587643 1.992262 -1.2468012 -1.3769499 1.10291e+01
## 38 0.1851852 -2.43979      27 0.0710986 20.21932  2.30675316 1.335356 -2.569935 0.0660436 0.0660436 1.335356  1.7274437  1.5972950 3.80705e+00
## 39 0.1363636 -2.57043      22 0.0629393 19.31375  1.41809946 1.139085 -2.700578 0.0589779 0.0589779 1.139085  1.2449462  1.1147975 1.53827e+00
## 40 0.0454545 -3.05130      22 0.0398698 23.97311  0.13388475 0.917695 -3.181451 0.0382802 0.0382802 0.917695  0.1458925  0.0157437 1.71749e-02
## 41 0.2000000 -1.26902      10 0.1981600  7.93320  0.01459699 1.260526 -1.397834 0.1588926 0.1588926 1.260526  0.0115801 -0.1172307 2.12578e-04
## 42 0.1250000 -2.43979       8 0.0711870 10.99969  0.59192615 0.727293 -2.568597 0.0661194 0.0661194 0.727293  0.8138755  0.6850648 2.90437e-01
## 43 0.0000000 -2.57043       6 0.0630182 10.08038 -0.63524785 0.595216 -2.699240 0.0590469 0.0590469 0.595216 -1.0672566 -1.1960674 7.81098e-01
## 44 0.0000000 -3.05130       5 0.0399210 11.42170 -0.45596580 0.437763 -3.180113 0.0383273 0.0383273 0.437763 -1.0415810 -1.1703917 4.07397e-01
## 45 0.0476190 -1.26902      21 0.1009549 15.21091 -0.81128654 1.380588 -2.186660 0.0907630 0.0907630 1.380588 -0.5876385 -1.5052746 8.02394e-01
## 46 0.0833333 -2.43979      24 0.0336529 27.16611  1.34962293 0.883454 -3.357422 0.0325204 0.0325204 0.883454  1.5276670  0.6100309 1.30471e+00
## 47 0.0000000 -2.57043      19 0.0296537 25.69649 -0.76199675 0.739401 -3.488065 0.0287744 0.0287744 0.739401 -1.0305599 -1.9481961 1.14389e+00
## 48 0.0000000 -3.05130      23 0.0185431 35.54976 -0.65920414 0.646980 -3.968938 0.0181993 0.0181993 0.646980 -1.0188935 -1.9365296 8.60992e-01
## 49 0.5789474 -1.26902      19 0.4569728  8.75026  1.06730866 2.171365 -0.172535 0.2481487 0.2481487 2.171365  0.4915382  1.5880262 1.13450e+00
## 50 0.0000000 -2.43979       2 0.2069682  3.49074 -0.72247281 0.572944 -1.343298 0.1641324 0.1641324 0.572944 -1.2609835 -0.1644954 9.27568e-01
## 51 0.0000000 -2.57043       3 0.1863444  4.44818 -0.82889297 0.674433 -1.473941 0.1516201 0.1516201 0.674433 -1.2290212 -0.1325331 1.23731e+00
## 52 0.0000000 -3.05130       2 0.1240294  4.29050 -0.53214810 0.466146 -1.954814 0.1086461 0.1086461 0.466146 -1.1415908 -0.0451028 5.29691e-01
## 53 0.0526316 -1.26902      19 0.1190865 13.45795 -0.89434733 1.411805 -2.001109 0.1049049 0.1049049 1.411805 -0.6334779 -1.3655634 9.85164e-01
## 54 0.0666667 -2.43979      15 0.0402381 19.70812  0.52085810 0.761107 -3.171872 0.0386190 0.0386190 0.761107  0.6843424 -0.0477431 2.27943e-01
## 55 0.0666667 -2.57043      15 0.0354850 20.93479  0.65278083 0.716511 -3.302514 0.0342258 0.0342258 0.716511  0.9110551  0.1789696 3.41026e-01
## 56 0.0000000 -3.05130      15 0.0222397 26.26427 -0.58410839 0.571118 -3.783388 0.0217451 0.0217451 0.571118 -1.0227455 -1.7548310 6.74721e-01

bobyqa(c(1,cc), devf, lower=c(0,rep.int(-Inf,length(cc))))[c("par","objective")]
#(gm2 <- glmer(form, cbpp, binomial, verbose=2L,start=list(theta=1,fixef=beta0)))
## (NM) 10: f = 184.412 at 0.626639 -1.30544 -1.13194    -1.26 -1.72795
## (NM) 20: f = 184.163 at 0.629359 -1.35641 -1.07759 -1.20202 -1.65189
## (NM) 30: f = 184.08 at 0.640353 -1.38857 -1.01071 -1.18052 -1.60929
## (NM) 40: f = 184.076 at  0.640445  -1.38577 -0.977862  -1.15513  -1.54908
## (NM) 50: f = 184.064 at   0.64654  -1.40831 -0.964377  -1.11461   -1.5536
## (NM) 60: f = 184.053 at  0.643778  -1.39792 -0.988953  -1.12656  -1.57987
## (NM) 70: f = 184.053 at  0.643778  -1.39792 -0.988953  -1.12656  -1.57987
## (NM) 80: f = 184.053 at  0.643778  -1.39792 -0.988953  -1.12656  -1.57987
## (NM) 90: f = 184.053 at  0.643778  -1.39792 -0.988953  -1.12656  -1.57987
## (NM) 100: f = 184.053 at  0.644047  -1.39907 -0.993223  -1.12877  -1.57934
## (NM) 110: f = 184.053 at  0.642874  -1.39967 -0.992298   -1.1285  -1.57801
## (NM) 120: f = 184.053 at  0.642076   -1.3984 -0.991959  -1.13004  -1.58077
## (NM) 130: f = 184.053 at  0.641924  -1.39881 -0.992174  -1.12909  -1.57964
## (NM) 140: f = 184.053 at   0.64236  -1.39821 -0.992412  -1.12858  -1.57941
## (NM) 150: f = 184.053 at  0.641905  -1.39837 -0.991914  -1.12857   -1.5805
## (NM) 160: f = 184.053 at  0.642238   -1.3983 -0.991863  -1.12806  -1.57972
## (NM) 170: f = 184.053 at  0.642057   -1.3984 -0.991899   -1.1282     -1.58
## (NM) 180: f = 184.053 at  0.642067  -1.39831 -0.991807  -1.12826  -1.57975
## (NM) 190: f = 184.053 at  0.642073  -1.39835 -0.991886   -1.1282  -1.57987
## (NM) 200: f = 184.053 at  0.642051  -1.39833 -0.991898  -1.12822   -1.5797
## (NM) 210: f = 184.053 at   0.64207  -1.39834 -0.991935  -1.12823  -1.57974
## (NM) 220: f = 184.053 at  0.642068  -1.39834 -0.991933  -1.12823  -1.57975
## Generalized linear mixed model fit by maximum likelihood ['glmerMod']
##  Family: binomial ( logit )
## Formula: cbind(incidence, size - incidence) ~ period + (1 | herd) 
##    Data: cbpp 

##      AIC      BIC   logLik deviance 
## 194.0531 204.1799 -92.0266 184.0531 

## Random effects:
##  Groups Name        Variance Std.Dev.
##  herd   (Intercept) 0.4123   0.6421  
## Number of obs: 56, groups: herd, 15

## Fixed effects:
##             Estimate Std. Error z value Pr(>|z|)    
## (Intercept)  -1.3983     0.2279  -6.137 8.41e-10 ***
## period2      -0.9919     0.3053  -3.248 0.001160 ** 
## period3      -1.1282     0.3260  -3.461 0.000539 ***
## period4      -1.5797     0.4287  -3.685 0.000229 ***
### converged value of beta
betac <- c(-1.39833759626125, -0.991920607288014, -1.12820340054034, -1.57972763125548)
### converged value of theta
thetac <- 0.642071294438882

## dput(deviance(gm2))  # 184.053132779715
